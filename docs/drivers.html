<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>AlpacaPi - Drivers</title>
	<link rel="stylesheet" href="styles.css">
</head>
<body>
	<div class="container">
		<header>
			<h1>AlpacaPi</h1>
			<h2>Drivers</h2>
		</header>

		<nav>
			<ul>
				<li><a href="index.html">Home</a></li>
				<li><a href="skytravel.html">SkyTravel</a></li>
				<li><a href="drivers.html">Drivers</a></li>
				<li><a href="clientapps.html">Client Apps</a></li>
				<li><a href="moonphase.html">Moon Phase</a></li>
				<li><a href="skyimage.html">SkyImage</a></li>
				<li><a href="aavsoTargetTool.html">AAVSO</a></li>
			</ul>
		</nav>

		<main>
			<p>AlpacaPi is the name I have given to my suite of Alpaca drivers and clients.</p>

			<p>The drivers are probably the most important piece to the puzzle.
			Once the driver is running for a particular device,
			then any program that speaks Alpaca can utilize that devices.
			This also includes a web browser.
			However you can not send action commands to the driver from a web browser.
			You can read all of the status.</p>

			<p>The AlpacaPi drivers run on Linux and were designed with the Raspberry-Pi in mind.
			They will run on most any flavor of linux.</p>

			<p>AlpacaPi drivers currently support the following devices.</p>
			<ul>
				<li><strong>Cameras</strong>
					<ul>
						<li>ATIK cameras</li>
						<li>FLIR grasshopper series cameras</li>
						<li>QHY cameras</li>
						<li>QSI cameras</li>
						<li>SONY A7 R IV DLSR camera</li>
						<li>TOUPTECH cameras</li>
						<li>ZWO cameras</li>
					</ul>
				</li>
				<li><strong>Domes</strong>
					<ul>
						<li>Raspberry Pi w/Motor control board for dome</li>
						<li>Raspberry Pi w/Motor control board for Roll Off Roof</li>
					</ul>
				</li>
				<li><strong>Filter Wheels</strong>
					<ul>
						<li>Atik filter-wheel</li>
						<li>QHY filter-wheel</li>
						<li>ZWO filter-wheel</li>
					</ul>
				</li>
				<li><strong>Focusers</strong>
					<ul>
						<li>Moonlite NiteCrawler</li>
						<li>Moonlite High Speed Stepper</li>
					</ul>
				</li>
				<li><strong>Observing Conditions</strong>
					<ul>
						<li>Raspberry Pi with sensors</li>
					</ul>
				</li>
				<li><strong>Rotator</strong>
					<ul>
						<li>Moonlite NiteCrawler</li>
					</ul>
				</li>
				<li><strong>Switches</strong>
					<ul>
						<li>Raspberry Pi with a 8 Relay board</li>
						<li>Raspberry Pi with a 4 Relay board</li>
						<li>Raspberry Pi with a WaveShare 3 Relay board</li>
					</ul>
				</li>
				<li><strong>Telescope (Mounts)</strong>
					<ul>
						<li>Talks LX200 via TCP/IP to tsc mount controller</li>
						<li>Rigel - Custom driver for Jim H.</li>
						<li>Raspberry Pi with Servo controller</li>
						<li>Skywatch</li>
					</ul>
				</li>
			</ul>

			<hr>

			<h3>Client and server operation</h3>
			<p>To utilize any of the drivers, first you have to build the driver and run it.
			Then you run the appropriate client program to access that driver.
			In my environment, there are normally on separate machines, the driver running on a Raspberry-Pi
			and the client program running on my Linux desktop computer.
			They can also be on the SAME machine.</p>

			<p>For example, if you want to utilize the 4 port switch (described below), follows these steps:</p>
			<ul>
				<li><strong>On the driver machine</strong>
					<ol>
						<li>make piswitch4</li>
						<li>./piswitch4</li>
					</ol>
				</li>
				<li><strong>On the client machine</strong> (can be the same as the driver machine)
					<ol>
						<li>make switch or make switchcv4</li>
						<li>./switch</li>
					</ol>
				</li>
			</ul>

			<p>You should then get a screen like the screen samble below:</p>
			<div class="image-gallery">
				<a href="images/Dome_controller.png" target="_blank">
					<img src="images/Dome_controller.png" alt="Dome controller" style="width: 200px;">
				</a>
				<a href="images/NiteCrawler_wo102_screenshot.jpg" target="_blank">
					<img src="images/NiteCrawler_wo102_screenshot.jpg" alt="NiteCrawler focuser" style="width: 200px;">
				</a>
				<a href="images/Switch-door-screenshot.jpg" target="_blank">
					<img src="images/Switch-door-screenshot.jpg" alt="Switch controller" style="width: 200px;">
				</a>
			</div>

			<hr>

			<h2>Dome driver</h2>
			<p>The AlpacaPi dome driver supports the following configurations:</p>
			<ul>
				<li><strong>Dome with rotation and single shutter</strong>
					<ul>
						<li>This option uses DC motor controllers</li>
					</ul>
				</li>
				<li><strong>Roll Off Roof with roof acting as the shutter</strong>
					<ul>
						<li>Version using relays for driving motors</li>
						<li>Version using DC motor controllers</li>
					</ul>
				</li>
			</ul>

			<p>A watchdog timer is also supported to close the dome if communications is lost.</p>
			<ul>
				<li>The watchdog timeout occurs if no commands have been received for the specified time.
				(default is 5 minutes). If SkyTravel is being used, it queries the dome driver every few seconds for status thus resetting the timeout.
				The Dome watchdog timer controls the dome shutter.
				If the timeout occurs, the shutter will close.</li>
				<li>The Dome movement timeout occurs if no MOVE command is received in the specified time
				(default is 2 hours). The Dome movement timer controls the dome position.
				If the timeout occurs, the dome will be sent back to the PARK position</li>
			</ul>

			<h4>Remote Shutter</h4>
			<p>The AlpacaPi dome driver supports the option of a separate drive that controls the door.
			This allows one device driver to be used for the dome since most client applications can only deal with one.
			While in reality there are 2 drivers. The primary DOME driver talks to the second driver (SHUTTER).</p>

			<p>The SHUTTER devices is a non-standard Alpaca device. It will not be recognized by other Alpaca clients. It responds to the same door/shutter commands as the DOME device.</p>

			<p>The AlpacaPi dome driver uses DC motors and a PWM controlled DC power board
			that handles reversing and power output.
			It also uses a terminal I/O board for connection to the DC controller and for sensor inputs.
			The sensor inputs are for door open and door close.
			Additional inputs can be used for positions in between.</p>

			<p>The Raspberry Pi only has one PWM (Pulse Width Modulation) for speed control.
			I use one R-Pi for dome rotation and a second R-Pi to control the door.
			This allows the door controller to be mounted on dome
			and use wireless to talk to the dome rotation controller that is mounted on the wall.</p>

			<p><strong class="highlight-red">Important Note:</strong>
			The Raspberry Pi is 3.3 logic, the input pins cannot accept voltage higer than 3.3 and
			the output pins only output 3.3 volts.</p>
			<p>The switch inputs are designed to go through a normal open swith that switches to ground.
			So the logic levels are inverted.  Reading a logic 1 means the switch is open and a logic 0 means it is closed.</p>

			<table>
				<tr>
					<th>Description</th>
					<th>Power board</th>
					<th>build / run commands</th>
					<th style="width: 175px;">Notes</th>
				</tr>
				<tr>
					<td>DC motor control</td>
					<td>
						<div class="center">
							<img src="images/Cytron_dc_power_control.jpg" alt="Cytron DC power control"><br>
							<a href="https://www.amazon.com/gp/product/B07L6HGFWY/" target="_blank">Click here for amazon description</a><br>
							<img src="images/DIN_Rail_Mount_Terminal_Block_RPi.jpg" alt="DIN Rail Mount Terminal Block"><br>
							<a href="https://www.amazon.com/Pinout-Breakout-Terminal-Module-Raspberry/dp/B08LL1LWLM/" target="_blank">Click here for amazon description</a>
						</div>
					</td>
					<td><pre>make dome
./domedriver</pre></td>
					<td></td>
				</tr>
			</table>

			<table>
				<tr>
					<th colspan="3">Raspberry-Pi Dome Driver</th>
				</tr>
				<tr>
					<th colspan="3">Hardware configuration</th>
				</tr>
				<tr>
					<td colspan="3" class="text-center">Using BCM Pin numbering</td>
				</tr>
				<tr>
					<td>Clockwise button pin</td>
					<td>23</td>
					<td>Input</td>
				</tr>
				<tr>
					<td>Counter Clockwise button pin</td>
					<td>24</td>
					<td>Input</td>
				</tr>
				<tr>
					<td>Stop button pin</td>
					<td>25</td>
					<td>Input</td>
				</tr>
				<tr>
					<td>Direction Control pin</td>
					<td>27</td>
					<td>Output</td>
				</tr>
				<tr>
					<td>Power PWM pin</td>
					<td>18</td>
					<td>Output</td>
				</tr>
				<tr>
					<td>Home Sensor pin</td>
					<td>5</td>
					<td>Input</td>
				</tr>
				<tr>
					<td>Park Sensor pin</td>
					<td>6</td>
					<td>Input</td>
				</tr>
			</table>

			<p><strong>NOTE:</strong> These pin numbers can be changed, this is the default list.</p>
			<p>Pin 18 cannot be changed, it is the only pin on the Raspberry Pi that supports PWM.</p>

			<p>These drivers require the wiringPi library. The <code>setup_complete.sh</code> script will automatically
			detect if you're on a Raspberry Pi and offer to install WiringPi if needed. Alternatively, you can install it manually:</p>
			<pre>cd AlpacaPi		(if not already connected to the directory)
./setup_complete.sh</pre>
			<p>When prompted, select to install WiringPi for Raspberry Pi GPIO support.</p>
			<p>To verify WiringPi installation, run:</p>
			<pre>gpio readall</pre>
			<p>You should get an output that looks like this</p>
			<pre> +-----+-----+---------+------+---+---Pi 4B--+---+------+---------+-----+-----+
 | BCM | wPi |   Name  | Mode | V | Physical | V | Mode | Name    | wPi | BCM |
 +-----+-----+---------+------+---+----++----+---+------+---------+-----+-----+
 |     |     |    3.3v |      |   |  1 || 2  |   |      | 5v      |     |     |
 |   2 |   8 |   SDA.1 |   IN | 1 |  3 || 4  |   |      | 5v      |     |     |
 |   3 |   9 |   SCL.1 |   IN | 1 |  5 || 6  |   |      | 0v      |     |     |
 |   4 |   7 | GPIO. 7 |   IN | 1 |  7 || 8  | 1 | IN   | TxD     | 15  | 14  |
 |     |     |      0v |      |   |  9 || 10 | 1 | IN   | RxD     | 16  | 15  |
 |  17 |   0 | GPIO. 0 |  OUT | 0 | 11 || 12 | 0 | ALT5 | GPIO. 1 | 1   | 18  |
 |  27 |   2 | GPIO. 2 |  OUT | 1 | 13 || 14 |   |      | 0v      |     |     |
 |  22 |   3 | GPIO. 3 |   IN | 0 | 15 || 16 | 1 | IN   | GPIO. 4 | 4   | 23  |
 |     |     |    3.3v |      |   | 17 || 18 | 1 | IN   | GPIO. 5 | 5   | 24  |
 |  10 |  12 |    MOSI |   IN | 0 | 19 || 20 |   |      | 0v      |     |     |
 |   9 |  13 |    MISO |   IN | 0 | 21 || 22 | 1 | IN   | GPIO. 6 | 6   | 25  |
 |  11 |  14 |    SCLK |   IN | 0 | 23 || 24 | 1 | IN   | CE0     | 10  | 8   |
 |     |     |      0v |      |   | 25 || 26 | 1 | IN   | CE1     | 11  | 7   |
 |   0 |  30 |   SDA.0 |   IN | 1 | 27 || 28 | 1 | IN   | SCL.0   | 31  | 1   |
 |   5 |  21 | GPIO.21 |   IN | 1 | 29 || 30 |   |      | 0v      |     |     |
 |   6 |  22 | GPIO.22 |   IN | 1 | 31 || 32 | 0 | OUT  | GPIO.26 | 26  | 12  |
 |  13 |  23 | GPIO.23 |   IN | 1 | 33 || 34 |   |      | 0v      |     |     |
 |  19 |  24 | GPIO.24 |   IN | 1 | 35 || 36 | 0 | OUT  | GPIO.27 | 27  | 16  |
 |  26 |  25 | GPIO.25 |   IN | 1 | 37 || 38 | 1 | IN   | GPIO.28 | 28  | 20  |
 |     |     |      0v |      |   | 39 || 40 | 1 | IN   | GPIO.29 | 29  | 21  |
 +-----+-----+---------+------+---+----++----+---+------+---------+-----+-----+
 | BCM | wPi |   Name  | Mode | V | Physical | V | Mode | Name    | wPi | BCM |
 +-----+-----+---------+------+---+---Pi 4B--+---+------+---------+-----+-----+</pre>

			<hr>

			<h3>Exploradome driver</h3>
			<p>The driver for the Exploradome is almost identical to the example above,
			same hardware with the addition of shutter control logic.
			Also, this option requires the stepper motor on the ExlporaDome to be replaced with a DC motor.
			I hope to do a version that utilizes the stepper motor in the future.</p>

			<h2>Raspberry-Pi Dome Driver</h2>
			<h3>ExploraDome implementation</h3>
			<table>
				<tr>
					<th colspan="4">Raspberry-Pi Dome Driver</th>
				</tr>
				<tr>
					<th colspan="4">Hardware configuration</th>
				</tr>
				<tr>
					<td colspan="4" class="text-center">Using BCM Pin numbering</td>
				</tr>
				<tr>
					<td>Clockwise button pin</td>
					<td>23</td>
					<td>Input</td>
					<td></td>
				</tr>
				<tr>
					<td>Counter Clockwise button pin</td>
					<td>24</td>
					<td>Input</td>
					<td></td>
				</tr>
				<tr>
					<td>Stop button pin</td>
					<td>25</td>
					<td>Input</td>
					<td></td>
				</tr>
				<tr>
					<td>Direction Control pin</td>
					<td>27</td>
					<td>Output</td>
					<td></td>
				</tr>
				<tr>
					<td>Power PWM pin</td>
					<td>18</td>
					<td>Output</td>
					<td></td>
				</tr>
				<tr>
					<td>Home Sensor pin</td>
					<td>5</td>
					<td>Input</td>
					<td></td>
				</tr>
				<tr>
					<td>Park Sensor pin</td>
					<td>6</td>
					<td>Input</td>
					<td></td>
				</tr>
				<tr>
					<th colspan="4">Specific to ExlporaDome implementation</th>
				</tr>
				<tr>
					<td>Open Complete Sensor pin</td>
					<td>20</td>
					<td>Input</td>
					<td></td>
				</tr>
				<tr>
					<td>Close Complete Sensor pin</td>
					<td>21</td>
					<td>Input</td>
					<td></td>
				</tr>
				<tr>
					<td>Shutter Open Button pin</td>
					<td>13</td>
					<td>Input</td>
					<td></td>
				</tr>
				<tr>
					<td>Shutter Close Button pin</td>
					<td>19</td>
					<td>Input</td>
					<td></td>
				</tr>
				<tr>
					<td>Shutter Stop Button pin</td>
					<td>26</td>
					<td>Input</td>
					<td></td>
				</tr>
				<tr>
					<td>Shutter Direction Control pin</td>
					<td>12</td>
					<td>Output</td>
					<td></td>
				</tr>
				<tr>
					<td>Shutter Motor Control pin</td>
					<td>16</td>
					<td>Output</td>
					<td></td>
				</tr>
			</table>

			<p>To build this version</p>
			<pre>make clean
make expdome
./alpacapi-expdome

<em>Note: on some systems, sudo may be required, this is a wiringPi requirement</em>
sudo ./alpacapi-expdome</pre>

			<hr>

			<h3>Switch driver</h3>
			<p>The switch driver on the Raspberry Pi requires the wiringpi library to be installed.
			The <code>setup_complete.sh</code> script will automatically detect if you're on a Raspberry Pi and offer to install WiringPi if needed.
			At present, the wiringpi library only works on the 32-bit versions of Raspberry Pi Linux.</p>

			<table>
				<tr>
					<th>Description</th>
					<th>Relay board</th>
					<th>build / run commands</th>
					<th style="width: 175px;">Notes</th>
				</tr>
				<tr>
					<td>8 Relay DIN mount</td>
					<td>
						<div class="center">
							<img src="images/RaspberryPi_DIN8portRelay-small.jpg" alt="8 Relay DIN mount"><br>
							<a href="https://www.amazon.com/Mount-Power-Relay-Module-Raspberry/dp/B084G9GLJG/" target="_blank">Click here for amazon description</a>
						</div>
					</td>
					<td><pre>make piswitch8
./piswitch8</pre></td>
					<td></td>
				</tr>
				<tr>
					<td>4 Relay</td>
					<td>
						<div class="center">
							<img src="images/RaspberryPi_4portRelay.jpg" alt="4 Relay board"><br>
							<a href="https://www.amazon.com/gp/product/B077LV4F1B/" target="_blank">Click here for amazon description</a>
						</div>
					</td>
					<td><pre>make piswitch4
./piswitch4</pre></td>
					<td></td>
				</tr>
				<tr>
					<td>WaveShare 3 Relay</td>
					<td>
						<div class="center">
							<img src="images/waveshare-3portrelay.jpg" alt="WaveShare 3 Relay"><br>
							<a href="https://www.amazon.com/dp/B0CDH1L58X?psc=1&ref=ppx_yo2ov_dt_b_product_details" target="_blank">Click here for amazon description</a><br>
							<a href="https://www.waveshare.com/rpi-relay-board.htm" target="_blank">WaveShare product page</a><br>
							<a href="https://www.waveshare.com/wiki/RPi_Relay_Board" target="_blank">WaveShare manual</a>
						</div>
					</td>
					<td><pre>make piswitch3
./piswitch3</pre></td>
					<td>
						This board has inverted logic to the relays.<br>
						A logic "0" turns the relay ON.<br>
						This may cause issues on start up.
					</td>
				</tr>
				<tr>
					<td>keyestudio 4 Relay</td>
					<td>
						<div class="center">
							<img src="images/Keystudio-Relay-Ks0212-1.png" alt="keyestudio 4 Relay"><br>
							<a href="https://www.amazon.com/KEYESTUDIO-4-Channel-Shield-Expansion-Raspberry/dp/B072XGF4Z3/ref=sr_1_1?crid=2BH7ARNF2R4W4&dib=eyJ2IjoiMSJ9.sgbpyZjiTK2G2h0BOBWGZw.1gMBf8TQwaJzzJ8ullqzBU-Khs-cP_-Mmo3ILgnWJOA&dib_tag=se&keywords=KS0212&qid=1721538353&sprefix=ks0212%2Caps%2C73&sr=8-1" target="_blank">Click here for Amazon description</a><br>
							<a href="https://wiki.keyestudio.com/KS0212_keyestudio_RPI_4-channel_Relay_Shield" target="_blank">Keyestudio 4 relay</a>
						</div>
					</td>
					<td><pre>make piswitch4ks
./piswitch4</pre></td>
					<td></td>
				</tr>
			</table>
		</main>
	</div>
</body>
</html>
